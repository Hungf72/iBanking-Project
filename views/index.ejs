<!doctype html>
<html lang="vi" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>iBanking Tuition — Thanh toán học phí</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
          colors: { brand: { DEFAULT:'#22c55e', 600:'#16a34a' }, night:'#0b1220' },
          boxShadow: {
            glow: '0 0 0 4px rgba(34,197,94,.28)',
            soft: '0 10px 30px -10px rgba(0,0,0,.5)',
            neon: '0 8px 24px -6px rgba(34,197,94,.45)'
          }
        }
      }
    }
  </script>

  <!-- Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <link rel="stylesheet" href="/css/style.css">

</head>
<body class="min-h-screen bg-fintech text-slate-100 font-sans antialiased">

  <!-- Accessibility: skip link -->
  <a href="#mainContent" class="sr-only focusable">Skip to main content</a>

  <!-- Top announcement strip (red) -->
  <div id="topStrip" class="top-strip fixed top-0 left-0 right-0 z-40">
    <div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8">
      <div class="py-2 text-sm text-white flex items-center justify-between">
        <div class="flex items-center gap-3">
          <i class="ph ph-megaphone"></i>
          <span>Chào mừng bạn đến với hệ thống thanh toán online</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Main header (white, centered logo + title) -->
  <header id="mainHeader" class="main-header fixed left-0 right-0 z-30">
    <div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between py-6">
        <div class="flex items-center gap-6">
          <img src="/image/logo.png" alt="logo" class="h-14 w-auto block">
          <div class="text-center md:text-left">
            <div class="text-xl font-extrabold text-slate-900">TRƯỜNG ĐẠI HỌC TÔN ĐỨC THẮNG</div>
            <div class="text-sm text-slate-600">CỔNG THANH TOÁN TRỰC TUYẾN</div>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <button id="loginBtn" class="px-3 py-2 rounded-md btn-rose text-sm">Đăng nhập</button>
          <div class="hidden items-center gap-2" id="profileSection">
            <div class="text-right">
              <div class="text-sm font-medium text-slate-900">Số dư khả dụng</div>
              <div id="headerBalance" class="text-lg font-bold text-brand">-</div>
            </div>
            <button id="profileBtn" class="p-2 rounded-md bg-brand/20 hover:bg-brand/30 transition-colors" title="Hồ sơ">
              <i class="ph ph-user-circle text-xl text-emerald-500"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Hero: full-width background with left text and right search card -->
  <section class="hero bg-hero bg-cover bg-center relative" aria-hidden="false">
    <div class="hero-overlay"></div>
    <div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 py-28">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-center">
        <!-- Left: large heading and description -->
        <div class="lg:col-span-7 text-white">
          <h1 class="text-4xl lg:text-3xl font-extrabold tracking-tight">HỆ THỐNG THANH TOÁN TRỰC TUYẾN - TDTU</h1>
          <div class="w-200 h-0.5 bg-white/70 my-6"></div>
          <p class="text-lg text-white/85 leading-relaxed">Cổng thanh toán trực tuyến sử dụng để người học thanh toán học phí tại trường Đại học Tôn Đức Thắng. Thanh toán an toàn, nhanh chóng, hỗ trợ nhiều hình thức.</p>
          <ul class="mt-5 space-y-2 text-white/80">
            <li>• Thanh toán an toàn, nhanh chóng, hỗ trợ nhiều hình thức.</li>
            <li>• Nộp học phí nhanh chóng, không phải xếp hàng.</li>
            <li>• Hỗ trợ thẻ ngân hàng (ATM, Visa, Master).</li>
            <li>• Lưu lịch sử giao dịch, theo dõi dễ dàng.</li>
          </ul>
        </div>

        <!-- Right: dark search card (keeps existing input IDs) -->
        <div id="student-search" class="lg:col-span-5">
          <div class="search-card rounded-xl p-6 shadow-neon">
            <label class="text-sm text-white/80">Tra cứu học phí</label>
            <div class="mt-3 relative">
              <i class="ph ph-identification-badge absolute left-4 top-1/2 -translate-y-1/2 text-white/70"></i>
              <input id="mssv" autofocus class="w-full pl-12 pr-36 py-4 rounded-md border border-white/10 bg-white/5 text-white placeholder-white/70 outline-none" placeholder="Nhập MSSV">
              <button id="lookupBtn" class="absolute right-1 top-1/2 -translate-y-1/2 h-11 px-6 rounded-md bg-rose-800 text-white font-semibold hover:brightness-95">Tìm kiếm <span class="ml-3">→</span></button>
            </div>
            <div id="lookupErr" class="text-sm text-rose-300 mt-3 min-h-[1.25rem]"></div>
            <!-- hero quick-pay removed as requested -->
          </div>
        </div>
      </div>
    </div>
  </section>

    <!-- Result & Quick pay -->
  <main id="student-tuition" class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Result -->
    <section class="lg:col-span-2 card pop">
      <div class="p-6 sm:p-8">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold flex items-center gap-2"><i class="ph ph-receipt"></i> Thông tin học phí</h2>
        </div>

        <!-- loading -->
        <div id="skeleton" class="hidden">
          <div class="animate-pulse space-y-3">
            <div class="h-4 bg-slate-700/40 rounded w-1/3"></div>
            <div class="h-4 bg-slate-700/40 rounded w-1/2"></div>
            <div class="h-4 bg-slate-700/40 rounded w-1/4"></div>
          </div>
        </div>
        <div id="result" class="text-sm text-slate-300">Vui lòng nhập MSSV để tra cứu.</div>
      </div>
    </section>

    <!-- Quick pay -->
    <aside class="card pop">
      <div class="p-6 sm:p-8">
        <h3 class="text-lg font-semibold flex items-center gap-2"><i class="ph ph-lightning"></i> Thanh toán nhanh</h3>
        <p class="text-slate-300/80 text-sm mt-1">Dùng kết quả tra cứu hiện tại để thực hiện thanh toán OTP.</p>
        <div class="mt-4">
          <button id="payBtn" class="w-full btn-rose">
            <i class="ph ph-credit-card"></i> Thanh toán ngay
          </button>
          <div id="payErr" class="text-sm text-rose-400 min-h-[1.25rem] mt-2"></div>
        </div>
      </div>
    </aside>
  </main>

  <!-- Recent table -->
  <section class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 mt-6 mb-12">
    <div class="rounded-3xl border border-white/10 bg-white/10 backdrop-blur-xl shadow-soft pop">
      <div class="p-6 sm:p-8">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-semibold flex items-center gap-2"><i class="ph ph-clock-counter-clockwise"></i> Giao dịch gần đây</h3>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="text-left text-slate-300/75 border-b border-white/10">
              <tr>
                <th class="py-2">Thời gian</th>
                <th class="py-2">MSSV</th>
                <th class="py-2">Số tiền</th>
                <th class="py-2">Trạng thái</th>
              </tr>
            </thead>
            <tbody id="recentTbody" class="divide-y divide-white/10"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- Backdrop & Modals -->
  <div id="modalBackDrop" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-50"></div>

  <!-- Login Modal -->
  <div id="loginModal" class="hidden fixed inset-0 z-50 grid place-items-center p-4">
    <div class="w-full max-w-md modal-card p-6 shadow-soft zoom">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">Đăng nhập</h3>
        <button class="modal-close-btn" data-close aria-label="Đóng">✕</button>
      </div>

      <label class="text-sm text-slate-300">Tài khoản</label>
      <input name="username" id="lgUser" type="text" class="mt-1 w-full rounded-lg border border-white/12 bg-transparent px-3 py-2 outline-none focus:shadow-glow" placeholder="user01">
      <label class="text-sm text-slate-300 mt-3">Mật khẩu</label>
      <div class="relative mt-1">
        <input name="password" id="lgPass" type="password" class="w-full rounded-lg border border-white/12 bg-transparent px-3 py-2 pr-10 outline-none focus:shadow-glow" placeholder="123456">
        <button type="button" id="togglePassword" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-300 transition-colors" title="Hiện/ẩn mật khẩu">
          <i id="eyeIcon" class="ph ph-eye text-lg"></i>
        </button>
      </div>
      <div id="lgErr" class="text-sm text-rose-400 mt-2 min-h-[1.25rem]"></div>
      <div class="flex justify-end gap-3 mt-4">
        <button type="submit" id="doLogin" class="rounded-lg bg-gradient-to-r from-brand to-emerald-400 px-4 py-2 font-semibold text-emerald-950 hover:scale-[.98] active:scale-95 transition shadow-neon">Đăng nhập</button>
      </div>
    </div>
  </div>

  <!--Profile Modal-->
  <div id="profileModal" class="hidden fixed inset-0 z-50 grid place-items-center p-4">
    <div class="w-full max-w-md modal-card p-6 shadow-soft zoom">
      <div class="flex items-start justify-between mb-4">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 bg-brand/20 rounded-full flex items-center justify-center">
            <i class="ph ph-user text-xl text-emerald-500"></i>
          </div>
          <div>
            <h3 class="text-lg font-semibold">Hồ sơ người dùng</h3>
            <p class="text-sm text-slate-300/80">Thông tin tài khoản</p>
          </div>
        </div>
        <button class="modal-close-btn" data-close aria-label="Đóng">✕</button>
      </div>

      <div class="space-y-4">
        <div class="p-4 rounded-xl bg-white/5 border border-white/10">
          <div class="grid grid-cols-1 gap-3">
            <div>
              <label class="text-sm text-slate-300/80">Tên đăng nhập</label>
              <p id="profileUsername" class="text-white font-medium">-</p>
            </div>
            <div>
              <label class="text-sm text-slate-300/80">Họ và tên</label>
              <p id="profileFullname" class="text-white font-medium">-</p>
            </div>
            <div>
              <label class="text-sm text-slate-300/80">Email</label>
              <p id="profileEmail" class="text-white font-medium">-</p>
            </div>
            <div>
              <label class="text-sm text-slate-300/80">Số điện thoại</label>
              <p id="profilePhone" class="text-white font-medium">-</p>
            </div>
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-3 mt-6">
        <button id="profileLogout" class="rounded-lg border border-rose-500/50 bg-rose-500/20 px-4 py-2 text-rose-300 hover:bg-rose-500/30">
          <i class="ph ph-sign-out mr-2"></i>Đăng xuất
        </button>
        <button class="rounded-lg border border-white/10 bg-white/6 px-4 py-2 hover:bg-white/10" data-close>Đóng</button>
      </div>
    </div>
  </div>

  <!-- Bank Transfer Modal -->
  <div id="transferModal" class="hidden fixed inset-0 z-50 grid place-items-center p-4">
    <div class="w-full max-w-md rounded-2xl border border-white/12 bg-slate-900/90 backdrop-blur-2xl p-6 shadow-2xl zoom">
      <div class="flex items-start justify-between mb-4">
        <div>
          <h3 class="text-lg font-semibold">Chuyển tiền tới số tài khoản</h3>
          <p class="text-sm text-slate-300/80">Vui lòng xác nhận thông tin trước khi tiếp tục</p>
        </div>
        <button class="modal-close-btn" data-close aria-label="Đóng">✕</button>
      </div>
      
      <!-- From account -->
      <div class="mb-5 p-4 rounded-xl border border-white/10 bg-white/5">
        <div class="text-sm text-slate-300/80">Nguồn chuyển tiền</div>
        <div>
          <div class="font-medium">TÀI KHOẢN THANH TOÁN</div>
          <div class="text-brand text-xl font-bold" id="transferAmount">-</div>
        </div>
      </div>
      
      <!-- To account -->
      <div class="mb-5 p-5 rounded-2xl border border-white/10 bg-white/5">
        <div class="text-sm text-slate-300/80 mb-2">Chuyển đến</div>
        
        <div class="flex items-center gap-4 mb-4">
          <div class="w-12 h-12 bg-rose-500/20 rounded-full flex items-center justify-center">
            <i class="ph ph-bank text-2xl text-rose-400"></i>
          </div>
          <div>
            <div class="font-semibold text-base text-white">TDTU BANK</div>
            <div class="text-sm text-slate-300/80">Trường Đại học Tôn Đức Thắng</div>
          </div>
        </div>
      
        <div class="border-t border-white/10 pt-4 space-y-3">
          <div>
            <div class="text-sm text-slate-300/80 mb-1">Số tài khoản</div>
            <div class="font-semibold text-lg text-white break-all" id="bankAccountNumber">
              19037000168888
            </div>
          </div>
          <div>
            <div class="text-sm text-slate-300/80 mb-1">Tên tài khoản</div>
            <div class="font-medium text-slate-100">
              TRUONG DAI HOC TON DUC THANG
            </div>
          </div>
        </div>
      </div>
      
  
      <!-- Transfer info -->
      <div class="mb-5 p-4 rounded-xl border border-white/10 bg-white/5">
        <div>
          <div class="text-sm text-slate-300/80">Số tiền chuyển</div>
          <div class="font-bold text-lg text-white" id="transferAmountValue">-</div>
        </div>
        
        <div class="border-t border-white/10 mt-3 pt-3">
          <div class="text-sm text-slate-300/80">Nội dung chuyển tiền</div>
          <div class="font-medium" id="transferContent">Thanh toán học phí cho sinh viên <span id="transferStudentId"></span></div>
        </div>
      </div>
      
      <div class="flex justify-between items-center mt-5">
        <button class="rounded-xl border border-white/10 bg-white/6 px-5 py-3 font-medium hover:bg-white/10" data-close>Quay lại</button>
        <button id="confirmTransfer" class="rounded-xl bg-gradient-to-r from-brand to-emerald-400 px-5 py-3 font-medium text-emerald-950 hover:scale-[.98] active:scale-95 transition shadow-lg">Tiếp tục</button>
      </div>
    </div>
  </div>

  <!-- OTP Modal -->
  <div id="otpModal" class="hidden fixed inset-0 z-50 grid place-items-center p-4">
    <div class="w-full max-w-md rounded-2xl border border-white/12 bg-slate-900/85 backdrop-blur-2xl p-6 shadow-soft zoom">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Xác nhận OTP</h3>
        <button class="close px-2 py-1 rounded-lg border border-white/10 bg-white/10 hover:bg-white/15" data-close>✕</button>
      </div>
      <p id="otpHint" class="text-sm text-slate-300/80">Nhập mã OTP (6 chữ số) vừa được gửi email.</p>
  
      <!-- OTP Inputs -->
      <div class="flex justify-between gap-2 mt-3">
        <input maxlength="1" class="otp-input w-10 h-12 text-center text-lg font-semibold rounded-lg border border-white/20 bg-slate-800/70 focus:shadow-glow"/>
        <input maxlength="1" class="otp-input w-10 h-12 text-center text-lg font-semibold rounded-lg border border-white/20 bg-slate-800/70 focus:shadow-glow"/>
        <input maxlength="1" class="otp-input w-10 h-12 text-center text-lg font-semibold rounded-lg border border-white/20 bg-slate-800/70 focus:shadow-glow"/>
        <input maxlength="1" class="otp-input w-10 h-12 text-center text-lg font-semibold rounded-lg border border-white/20 bg-slate-800/70 focus:shadow-glow"/>
        <input maxlength="1" class="otp-input w-10 h-12 text-center text-lg font-semibold rounded-lg border border-white/20 bg-slate-800/70 focus:shadow-glow"/>
        <input maxlength="1" class="otp-input w-10 h-12 text-center text-lg font-semibold rounded-lg border border-white/20 bg-slate-800/70 focus:shadow-glow"/>
      </div>
  
      <!-- error -->
      <div id="otpErr" class="text-sm text-rose-400 mt-2 min-h-[1.25rem]"></div>
  
      <div class="flex justify-between items-center mt-3">
        <span id="otpTimer" class="px-3 py-1 rounded-full text-xs font-medium bg-gradient-to-r from-rose-500/20 to-red-500/20 text-rose-400 border border-rose-400/40 shadow-sm transition-all duration-300">
        </span>
        <button id="resendOtp" class="hidden text-sm font-semibold text-emerald-400 hover:text-emerald-300 hover:underline transition">
          Gửi lại OTP
        </button>
      </div>

      <!-- confirm -->
      <div class="flex justify-end mt-4">
        <button id="doConfirm" class="rounded-xl bg-gradient-to-r from-brand to-emerald-400 px-4 py-2 font-semibold text-emerald-950 hover:scale-[.98] active:scale-95 transition shadow-neon">
          Xác nhận
        </button>
      </div>
    </div>
  </div>
  

  <!-- Welcome Modal -->
  <div id="welcomeModal" class="hidden fixed inset-0 z-50 grid place-items-center p-4" role="dialog" aria-modal="true" aria-labelledby="welcomeTitle" aria-describedby="welcomeDesc">
    <div class="w-full max-w-4xl rounded-3xl border border-white/8 bg-gradient-to-br from-slate-900/85 to-slate-800/75 backdrop-blur-2xl p-6 md:p-8 shadow-neon zoom">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
        <!-- Left: Illustration -->
        <div class="welcome-left rounded-xl overflow-hidden bg-gradient-to-tr from-emerald-600/10 to-sky-400/6 p-1">
          <img src="/image/Welcome.jpg" alt="Welcome" class="welcome-illustration w-full h-56 md:h-72 object-cover rounded-lg shadow-soft">
        </div>

        <!-- Right: Content -->
        <div class="welcome-right text-left">
          <div class="flex items-start justify-between">
            <div>
              <h3 id="welcomeTitle" class="text-2xl md:text-3xl font-extrabold">Chào mừng đến với iBanking Tuition</h3>
              <p id="welcomeDesc" class="text-sm md:text-base text-slate-300/80 mt-2">Tra cứu & thanh toán học phí nhanh chóng, an toàn. Dễ dàng kiểm tra số tiền cần nộp và thực hiện thanh toán trực tuyến qua OTP.</p>
            </div>
            <button aria-label="Đóng" class="close ml-4 px-2 py-1 rounded-lg border border-white/10 bg-white/10 hover:bg-white/15" data-close title="Đóng">✕</button>
          </div>

          <ul class="mt-4 space-y-2 text-sm text-slate-200/85">
            <li class="flex items-start gap-3"><span class="inline-grid place-items-center text-emerald-300 bg-emerald-500/10 rounded-full w-7 h-7"><i class="ph ph-check-bold"></i></span> Tra cứu theo MSSV — nhanh, chính xác.</li>
            <li class="flex items-start gap-3"><span class="inline-grid place-items-center text-amber-300 bg-amber-500/10 rounded-full w-7 h-7"><i class="ph ph-lock"></i></span> Thanh toán an toàn bằng OTP.</li>
            <li class="flex items-start gap-3"><span class="inline-grid place-items-center text-sky-300 bg-sky-500/10 rounded-full w-7 h-7"><i class="ph ph-clock"></i></span> Lưu lịch sử giao dịch nhanh chóng.</li>
          </ul>

          <div class="mt-6 flex items-center gap-3">
            <button id="welcomeStart" class="rounded-2xl bg-gradient-to-r from-brand to-emerald-400 px-5 py-3 font-semibold text-emerald-950 hover:scale-[.98] active:scale-95 transition shadow-neon">Bắt đầu</button>
            <button class="rounded-2xl border border-white/10 bg-white/6 px-4 py-3 text-sm text-slate-200/90 hover:bg-white/10" data-close>Đóng</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 hidden max-w-sm rounded-xl border border-white/10 bg-slate-900/92 backdrop-blur px-4 py-3 text-slate-100 shadow-soft slide-in"></div>

  <!-- Logic -->
  <script>
    // (theme toggle removed)

  // ===== Globals / State =====
  const $ = (s,el=document)=>el.querySelector(s);
  let queued = null;

  const tokenKey='token', userKey='user';
  const DEFAULT_API='http://localhost:8080';
  
  // load transaction
  async function loadTransactions(userId) {
    try {
      const res = await authFetch(`/api/transactions/${userId}`);
      const transactions = await res.json();
  
      const tbody = document.getElementById("recentTbody");
      tbody.innerHTML = '';
  
      transactions.forEach(tx => {
        const tr = document.createElement("tr");
  
        const stateClass = tx.State 
          ? "text-green-300 border-green-300/30 bg-green-300/10"   // Đã thanh toán
          : "text-yellow-300 border-yellow-300/30 bg-yellow-300/10"; // Chưa xử lý
  
        const stateText = tx.State ? "Đã thanh toán" : "Chưa xử lý";
  
        tr.innerHTML = `
          <td class="py-2">${new Date(tx.TransactionDate).toLocaleString('vi-VN')}</td>
          <td class="py-2">${tx.StudentID}</td>
          <td class="py-2">${fmt(tx.Amount)}</td>
          <td class="py-2">
            <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs border ${stateClass}">
              ${stateText}
            </span>
          </td>
        `;
  
        tbody.appendChild(tr);
      });
    } catch (e) {
      console.error("Lỗi tải giao dịch:", e);
    }
  }

  // Read API base from localStorage if set, otherwise use default.
  function api(){ return (localStorage.getItem('apiBase') || DEFAULT_API).replace(/\/$/, ''); }

    function token(){ return localStorage.getItem(tokenKey) || '' }
    function setAuth(t, u) {
      localStorage.setItem(tokenKey, t);
      localStorage.setItem(userKey, JSON.stringify(u));
    
      renderAuth();
    
      if (u && u.id) {
        loadTransactions(u.id); 
        $('#profileUsername').textContent = u.username || '-';
        $('#profileFullname').textContent = u.fullname || '-';
        $('#profileEmail').textContent = u.email || '-';
        $('#profilePhone').textContent = u.phone || '-';
      }
    
      openModal('#welcomeModal');
    }
    
    function clearAuth(){ localStorage.removeItem(tokenKey); localStorage.removeItem(userKey); localStorage.removeItem('userDetails'); renderAuth(); }
    function renderAuth(){ 
      const on = !!token(); 
      $('#loginBtn').classList.toggle('hidden', on); 
      $('#profileSection').classList.toggle('hidden', !on);
      $('#profileSection').classList.toggle('flex', on);
    
      if(on) {
        const u = JSON.parse(localStorage.getItem(userKey) || '{}');
        if (u.id) {
          loadTransactions(u.id);  
        }
        updateHeaderBalance();
      }
    }
    
    renderAuth();

    function authFetch(path, opts={}){
      const headers = Object.assign({'Content-Type':'application/json'}, opts.headers||{});
      if (token()) headers['Authorization'] = 'Bearer ' + token();
      return fetch(api()+path, Object.assign({}, opts, { headers }));
    }

    // ===== Toast =====
    function toast(text){ const t=$('#toast'); t.textContent=text; t.classList.remove('hidden'); t.classList.add('slide-in'); setTimeout(()=> t.classList.add('hidden'), 2400); }

    // ===== Backdrop & Modal =====
    const backdrop = $('#modalBackDrop');

    function openModal(sel){ 
      backdrop.classList.remove('hidden'); 
      backdrop.classList.add('flex'); 
      $(sel).classList.remove('hidden'); 
    }

    function closeAll(){ 
      backdrop.classList.add('hidden'); 
      ['#loginModal','#otpModal','#welcomeModal','#profileModal','#transferModal'].forEach(id=>$(id).classList.add('hidden')); 
    }

    document.querySelectorAll('[data-close]').forEach(b=> b.addEventListener('click', closeAll));
    backdrop.addEventListener('click', closeAll);

    // ===== Lookup Tuition =====
    let lastLookup = null;
    let currentSID = null;
    
    $('#lookupBtn').addEventListener('click', async () => {
      const mssv = $('#mssv').value.trim();
      $('#lookupErr').textContent = ''; 
      $('#result').innerHTML = '';

      if(!token()) {
        // hien login modal
        document.getElementById('loginModal').classList.remove('hidden');
        return; 
      }
    
      if (!mssv) { 
          $('#lookupErr').textContent = 'Vui lòng nhập MSSV'; 
          return; 
      }
    
      $('#skeleton').classList.remove('hidden');
    
      try {
        const res = await authFetch('/api/students?' + new URLSearchParams({ mssv }), { method: 'GET' });
        const data = await res.json();
    
        if (!res.ok) throw new Error(data?.message || 'Tra cứu thất bại');
    
        lastLookup = data;
        currentSID = mssv;
    
        const student = data.student || { mssv: "-", full_name: "-" };
        const invoice = data.invoice || { amount_due: 0, amount_paid: 0, status: "-" };
    
        const html = `
          <div class="border border-white/12 rounded-2xl p-4 bg-white/5">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div><span class="text-slate-300/90">MSSV:</span> <b>${student.mssv}</b></div>
              <div><span class="text-slate-300/90">Họ tên:</span> <b>${student.full_name}</b></div>
              <div><span class="text-slate-300/90">Tổng phải nộp:</span> <b>${fmt(invoice.amount_due)}</b></div>
              <div><span class="text-slate-300/90">Trạng thái:</span>
                <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-semibold shadow-md ${tagColor(invoice.status)}">
                  ${statusIcon(invoice.status)} ${invoice.status}
                </span>
              </div>              
            </div>
          </div>`;
    
        $('#result').innerHTML = html;

        smoothScrollTo("student-tuition"); 
    
      } catch (e) {
        $('#lookupErr').textContent = e.message || 'Lỗi không xác định';
        lastLookup = null;
        currentSID = null;
      } finally {
        $('#skeleton').classList.add('hidden');
      }
    });
    
    function renderStudentCard(student, invoice){
      const template = document.querySelector('#studentCardTemplate').cloneNode(true);
      template.classList.remove('hidden');
      template.removeAttribute('id');
    
      template.querySelector('[data-field="mssv"]').textContent = student.mssv || '-';
      template.querySelector('[data-field="full_name"]').textContent = student.full_name || '-';
      template.querySelector('[data-field="amount_due"]').textContent = fmt(invoice.amount_due);
      template.querySelector('[data-field="amount_paid"]').textContent = fmt(invoice.amount_paid);
    
      const statusEl = template.querySelector('[data-field="status"]');
      const tag = template.querySelector('.status-tag');
      statusEl.textContent = invoice.status || '-';
      tag.className = "status-tag inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-semibold shadow-md " + tagColor(invoice.status);
      tag.innerHTML = `${statusIcon(invoice.status)} ${invoice.status}`;
    
      return template;
    }
    
    function statusIcon(txt=''){
      const t = (txt||'').toLowerCase();
      if(t.includes('đã')||t.includes('paid')) return '<i class="ph ph-check-circle"></i>';
      if(t.includes('chờ')||t.includes('pending')) return '<i class="ph ph-hourglass"></i>';
      if(t.includes('quá')||t.includes('overdue')) return '<i class="ph ph-x-circle"></i>';
      return '<i class="ph ph-info"></i>';
    }

    function tagColor(text=''){
      const t=text.toLowerCase();
      if(t.includes('đã')||t.includes('paid')) 
        return 'bg-emerald-500 text-white border border-emerald-600';
      if(t.includes('chờ')||t.includes('pending')) 
        return 'bg-amber-500 text-black border border-amber-600';
      if(t.includes('quá')||t.includes('overdue')) 
        return 'bg-rose-600 text-white border border-rose-700';
      return 'bg-slate-500 text-white border border-slate-600';
    }    
    
    function fmt(v){ 
      return (v==null)?'-':Number(v).toLocaleString('vi-VN',{style:'currency',currency:'VND'}); 
    }

    // ===== Pay (prepare + OTP) =====
    let lastPayment = null;
    let otpExpireAt = null;
    let otpTimerInterval = null;

    $('#payBtn').addEventListener('click', () => ensureLoginThen(doPrepare));

    async function doPrepare() {
      $('#payErr').textContent = '';
      try {
        const mssv = $('#mssv').value.trim();
        if (!mssv || !lastLookup) {
          $('#payErr').textContent = 'Vui lòng tra cứu MSSV trước';
          smoothScrollTo("student-search");
          return;
        }
        
        // Populate transfer modal information
        const userDetails = JSON.parse(localStorage.getItem('userDetails') || '{}');
        $('#transferAmount').textContent = userDetails.AvailableBalance ? fmt(userDetails.AvailableBalance) : '-';
        $('#transferAmountValue').textContent = lastLookup?.invoice?.amount_due ? fmt(lastLookup.invoice.amount_due) : '-';
        $('#transferStudentId').textContent = mssv;
        
        // Show transfer modal 
        openModal('#transferModal');
      } catch (e) {
        $('#payErr').textContent = e.message || 'Lỗi không xác định';
      }
    }
    
    // Handle the transfer confirmation before proceeding to OTP
    $('#confirmTransfer').addEventListener('click', async () => {
      try {
        const mssv = $('#mssv').value.trim();
        
        const res = await authFetch('/api/payments/otp', {
          method: 'POST',
          body: JSON.stringify({ mssv })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.message || 'Gửi OTP thất bại');

        lastPayment = { id: data.payment_id, otp_id: data.otp_id, idempotencyKey: data.idempotencyKey };

        // Cập nhật giao diện
        $('#otpHint').textContent = `${data.message}`;
        document.querySelectorAll('.otp-input').forEach(i => i.value = "");
        $('#otpErr').textContent = "";
        $('#doConfirm').disabled = false;
        $('#resendOtp').classList.add("hidden");

        closeAll(); // Close transfer modal
        openModal('#otpModal');
        toast('Đã gửi OTP tới email');

        // Setup thời gian hết hạn OTP (60s)
        otpExpireAt = Date.now() + 60 * 1000;
        startOtpCountdown();

        // Focus vào ô OTP đầu tiên
        document.querySelector('.otp-input').focus();
      } catch (e) {
        $('#payErr').textContent = e.message || 'Lỗi không xác định';
      }
    });

    function startOtpCountdown() {
      clearInterval(otpTimerInterval);
      unlockOtpInputs();
      otpTimerInterval = setInterval(() => {
        const now = Date.now();
        const diff = otpExpireAt - now;

        if (diff <= 0) {
          clearInterval(otpTimerInterval);
          document.querySelector('#otpTimer').textContent = "Hết hạn";
          document.querySelector('#otpTimer').classList.replace("text-rose-400", "text-gray-300");
        
          lockOtpInputs();
        
          document.querySelector('#resendOtp').classList.remove("hidden");
          return;
        }
        

        const sec = Math.floor(diff / 1000);
        $('#otpTimer').textContent = `Còn ${sec}s`;
      }, 1000);
    }

    // input 0 - 9
    document.querySelectorAll(".otp-input").forEach(input => {
      input.addEventListener("input", (e) => {
        e.target.value = e.target.value.replace(/[^0-9]/g, ""); 
        if (e.target.value.length === 1) {
          let next = e.target.nextElementSibling;
          if (next && next.classList.contains("otp-input")) next.focus();
        }
      });
    
      input.addEventListener("keydown", (e) => {
        if (e.key === "Backspace" && !e.target.value) {
          let prev = e.target.previousElementSibling;
          if (prev && prev.classList.contains("otp-input")) prev.focus();
        }
      });
    });

    // auto-focus OTP input
    document.querySelectorAll('.otp-input').forEach((input, idx, arr) => {
      input.addEventListener("input", (e) => {
        if (e.target.value && idx < arr.length - 1) arr[idx + 1].focus();
      });
      input.addEventListener("keydown", (e) => {
        if (e.key === "Backspace" && !e.target.value && idx > 0) arr[idx - 1].focus();
      });
    });

    function lockOtpInputs() {
      document.querySelectorAll('.otp-input').forEach(inp => {
        inp.readOnly = true;                
        inp.classList.add("opacity-50");    
      });
      document.querySelector('#doConfirm').readOnly = true;
      document.querySelector('#doConfirm').classList.add("opacity-50", "cursor-not-allowed");
    }
    
    function unlockOtpInputs() {
      document.querySelectorAll('.otp-input').forEach(inp => {
        inp.readOnly = false;               
        inp.classList.remove("opacity-50");
      });
      document.querySelector('#doConfirm').readOnly = false;
      document.querySelector('#doConfirm').classList.remove("opacity-50", "cursor-not-allowed");
    }
  
    // resend OTP
    $('#resendOtp').addEventListener("click", async () => {
      const mssv = $('#mssv').value.trim();
      if (!lastPayment || !mssv) return;
    
      try {
        const res = await authFetch('/api/payments/otp', {
          method: 'POST',
          body: JSON.stringify({ mssv })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.message || 'Gửi lại OTP thất bại');
    
        lastPayment = { id: data.payment_id, otp_id: data.otp_id }; // update OTP mới
    
        $('#otpErr').textContent = "";
        $('#doConfirm').disabled = false;
        $('#resendOtp').classList.add("hidden");
    
        otpExpireAt = Date.now() + 60 * 1000;
        startOtpCountdown();
    
        document.querySelectorAll('.otp-input').forEach(i => i.value = "");
        document.querySelector('.otp-input').focus();
    
        toast('Đã gửi lại OTP tới email');
    
      } catch (e) {
        $('#otpErr').textContent = e.message || 'Lỗi không xác định';
      }
    });
    
    // confirm otp
    $('#doConfirm').addEventListener('click', async ()=>{
      $('#otpErr').textContent='';
      try{
        if(!lastPayment){ $('#otpErr').textContent='Không tìm thấy giao dịch'; return; }
    
        // Lấy mã OTP từ tất cả input
        const code = Array.from(document.querySelectorAll('.otp-input')).map(i => i.value).join('');

        if(code.length !== 6)
        {
          $('#otpErr').textContent='Vui lòng nhập đủ 6 chữ số'; 
          return; 
        }
    
        const res = await authFetch(`/api/payments/${lastPayment.id}/confirm?`+
        new URLSearchParams(
          { otp_id: lastPayment.otp_id }), 
          {method:'POST', body: JSON.stringify(
            { 
              otp: code, 
              mssv: currentSID, 
              impedanceKey: lastPayment.idempotencyKey
            })
        });

        const data = await res.json();

        if(!res.ok){
          throw new Error(data?.message || 'Xác nhận thất bại');
        }

        toast('Thanh toán thành công!');

        const userDetails = JSON.parse(localStorage.getItem('userDetails') || '{}');
        if(userDetails?.UserID){

          await loadTransactions(userDetails.UserID);

          await updateHeaderBalance();

          await refreshLookup();
        }

        closeAll();
      } catch(e){ $('#otpErr').textContent = e.message || 'Lỗi không xác định'; }
    });
    
  
    // ===== Login =====
    $('#loginBtn').addEventListener('click', ()=> openModal('#loginModal'));

    // Password toggle
    $('#togglePassword').addEventListener('click', ()=> {
      const passwordInput = $('#lgPass');

      const eyeIcon = $('#eyeIcon');
      const isPassword = passwordInput.type === 'password';
      
      passwordInput.type = isPassword ? 'text' : 'password';
      eyeIcon.className = isPassword ? 'ph ph-eye-slash text-lg' : 'ph ph-eye text-lg';
    });

    // ===== Login =====
    $('#doLogin').addEventListener('click', async ()=>{
    
      $('#lgErr').textContent='';
      try{
        const payload={ 
          username: $('#lgUser').value.trim(), 
          password: $('#lgPass').value 
        };
        const res = await fetch(api()+'/api/login', { 
          method:'POST', 
          headers:{'Content-Type':'application/json'}, 
          body: JSON.stringify(payload) 
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data?.message || 'Đăng nhập thất bại');
        
        // Store user details
        if(data.details) {
          localStorage.setItem('userDetails', JSON.stringify(data.details));
        }
        
        setAuth(data.token, data.user);
        closeAll(); 
        toast('Đăng nhập thành công');

        if(data.user?.id) {
          loadTransactions(data.user.id);
        }
        if(queued){ const fn=queued; queued=null; fn(); }
      }catch(e){ $('#lgErr').textContent = e.message || 'Lỗi không xác định'; }
    });

    // ===== Profile Modal =====
    async function updateHeaderBalance() {
      try {
        const userDetails = JSON.parse(localStorage.getItem('userDetails') || '{}');
        
        if (!userDetails?.UserID) {
          $('#headerBalance').textContent = '-';
          return;
        }
    
        const res = await authFetch(`/api/balance/${userDetails.UserID}`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || "Không lấy được số dư");

        userDetails.AvailableBalance = data.availableBalance;
        localStorage.setItem('userDetails', JSON.stringify(userDetails));
        $('#headerBalance').textContent = fmt(data.availableBalance);


      } catch (e) {
        console.error("Lỗi updateHeaderBalance:", e);
        $('#headerBalance').textContent = '-';
      }
    }
    

    $('#profileBtn').addEventListener('click', ()=> {
      // Load user data from localStorage
      try {
        const userData = JSON.parse(localStorage.getItem(userKey) || '{}');
        $('#profileUsername').textContent = userData.username || '-';

        const userDetails = JSON.parse(localStorage.getItem('userDetails') || '{}');

        $('#profileFullname').textContent = userDetails.Fullname || '-';
        $('#profileEmail').textContent = userDetails.Email || '-';
        $('#profilePhone').textContent = userDetails.PhoneNum || '-';
        $('#profileBalance').textContent = userDetails.AvailableBalance ? fmt(userDetails.AvailableBalance) : '-';
        
        // Update header balance as well
        updateHeaderBalance();
      } catch(e) {
        console.error('Error loading user data:', e);
      }
      openModal('#profileModal');
    });

    $('#profileLogout').addEventListener('click', ()=> {
      clearAuth();
      closeAll();
      logout();
      toast('Đã đăng xuất thành công');
    });

    // ===== Login guard =====
    function ensureLoginThen(fn){ if(token()) fn(); else { queued=fn; openModal('#loginModal'); } }

    // ===== Welcome modal (show once) =====
    (function(){
      try{
        const seen = localStorage.getItem('seenWelcome');
        if(!seen){ // first visit
          openModal('#welcomeModal');
          // mark as seen when user interacts
          const startBtn = $('#welcomeStart');
          if(startBtn) startBtn.addEventListener('click', ()=>{ 
            localStorage.setItem('seenWelcome','1'); 
            closeAll(); 
            $('#mssv').focus(); 
          });
          // also close on backdrop/close button (closeAll already marks nothing) but mark seen
          document.querySelectorAll('[data-close]').forEach(b=> b.addEventListener('click', ()=> localStorage.setItem('seenWelcome','1')));
          backdrop.addEventListener('click', ()=> localStorage.setItem('seenWelcome','1'));
        }
      }catch(e){ /* ignore localStorage errors */ }
    })();
    
    // ===== Header padding sync & shrink on scroll =====
    (function(){
      const top = document.getElementById('topStrip');
      const hdr = document.getElementById('mainHeader');
      function sync(){
        try{
          const topH = top ? top.getBoundingClientRect().height : 0;
          const hdrH = hdr ? hdr.getBoundingClientRect().height : 0;
          const total = topH + hdrH;
          // Apply padding to the document body so the very first sections (hero) are pushed down
          // keep a small breathing gap (8px) so elements don't touch the header
          document.body.style.paddingTop = (total - 11) + 'px';
          if(hdr) hdr.style.top = (topH) + 'px';
        }catch(e){/* ignore */}
      }
      sync();
      window.addEventListener('resize', sync);

      let lastY=0; const threshold=60;
      window.addEventListener('scroll', ()=>{
        const y = window.scrollY || window.pageYOffset;
        if(!hdr) return;
        if(y>threshold && y>lastY) hdr.classList.add('shrunk');
        else if(y<threshold || y<lastY) hdr.classList.remove('shrunk');
        lastY = y;
        // re-sync padding so layout doesn't jump
        sync();
      }, { passive:true });
    })();

    // ===== Logout =====
    function logout() {
      try {

        localStorage.clear();
        const tbody = document.getElementById("recentTbody");
        if (tbody) tbody.innerHTML = "";

        const result = document.getElementById("result");
        if (result) result.innerHTML = "";

        const skeleton = document.getElementById("skeleton");
        if (skeleton) skeleton.classList.add("hidden");

        const mssvInput = document.getElementById("mssv");
        if (mssvInput) mssvInput.value = "";

        window.currentSID = null;

        $('#profileSection').classList.add("hidden");
        $('#loginBtn').classList.remove("hidden");

        $('#profileUsername').textContent = "-";
        $('#profileFullname').textContent = "-";
        $('#profileEmail').textContent = "-";
        $('#profilePhone').textContent = "-";
    
        toast("Đăng xuất thành công");
      } catch (e) {
        console.error("Lỗi khi logout:", e);
      }
    }

    // ===== refresh lookup =====
    async function refreshLookup() {
      try {
        if (!currentSID) return;
        $('#result').innerHTML = '';
        $('#skeleton').classList.remove('hidden');
    
        const res = await authFetch('/api/students?' + new URLSearchParams({ mssv: currentSID }), { method: 'GET' });
        const data = await res.json();
    
        if (!res.ok) throw new Error(data?.message || 'Không thể cập nhật thông tin sinh viên');
    
        const student = data.student || { mssv: "-", full_name: "-" };
        const invoice = data.invoice || { amount_due: 0, amount_paid: 0, status: "-" };
    
        const html = `
          <div class="border border-white/12 rounded-2xl p-4 bg-white/5">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div><span class="text-slate-300/90">MSSV:</span> <b>${student.mssv}</b></div>
              <div><span class="text-slate-300/90">Họ tên:</span> <b>${student.full_name}</b></div>
              <div><span class="text-slate-300/90">Tổng phải nộp:</span> <b>${fmt(invoice.amount_due)}</b></div>
              <div><span class="text-slate-300/90">Trạng thái:</span>
                <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-semibold shadow-md ${tagColor(invoice.status)}">
                  ${statusIcon(invoice.status)} ${invoice.status}
                </span>
              </div>              
            </div>
          </div>`;
        $('#result').innerHTML = html;
    
      } catch (e) {
        console.error("reloadLookup lỗi:", e);
      } finally {
        $('#skeleton').classList.add('hidden');
      }
    }
    
    function smoothScrollTo(elementId) {
      const element = document.getElementById(elementId);
      const header = document.querySelector("header") || document.querySelector("nav");
    
      if (element) {
        const headerHeight = header ? header.offsetHeight : 0; // đo chiều cao header
        const elementPosition = element.getBoundingClientRect().top + window.scrollY - headerHeight - 15;
    
        window.scrollTo({
          top: elementPosition,
          behavior: "smooth"
        });
      }
    }
        
    document.addEventListener("DOMContentLoaded", () => {
      const userDetails = localStorage.getItem("userDetails");
      if(userDetails){
        try {
          const parsed = JSON.parse(userDetails);
          if(parsed?.id){
            loadTransactions(parsed.id);
          }
        } catch(e){
          console.error("Lỗi parse userDetails:", e);
        }
      }
    });
    
  </script>
</body>
</html>
