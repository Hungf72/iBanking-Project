<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>iBanking Tuition — Fintech Neo UI</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          boxShadow: { glow: '0 0 0 4px rgba(16,185,129,.28)' },
          colors: { brand: { DEFAULT:'#10b981', 600:'#059669' } }
        }
      }
    }
  </script>
  <!-- Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <style>
    /* animated gradient background */
    .bg-neo {
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(99,102,241,.18), transparent 60%),
        radial-gradient(700px 420px at 85% 70%, rgba(16,185,129,.18), transparent 60%),
        linear-gradient(135deg, #0f172a 0%, #0b1220 60%, #060b16 100%);
      position: relative;
      overflow: hidden;
    }
    .bg-neo:before {
      content:''; position:absolute; inset:-40%;
      background: conic-gradient(from 0deg, rgba(16,185,129,.09), rgba(99,102,241,.08), rgba(168,85,247,.06), rgba(16,185,129,.09));
      filter: blur(80px); animation: spin 30s linear infinite; opacity:.55; pointer-events: none;
    }
    @keyframes spin { to { transform: rotate(1turn) } }

    /* modal pop animation */
    .pop { animation: pop .18s ease-out; }
    @keyframes pop { from {opacity:0; transform:translateY(8px) scale(.98)} to {opacity:1; transform:translateY(0) scale(1)} }

    /* shimmer skeleton */
    .shimmer { position: relative; overflow: hidden; }
    .shimmer:after { content:''; position:absolute; inset:0; transform:translateX(-100%);
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.08), transparent);
      animation: shimmer 1.2s infinite; }
    @keyframes shimmer { 100% { transform:translateX(100%) } }
  </style>
</head>
<body class="min-h-screen text-slate-100 bg-neo antialiased">
  <script>
    // init theme (dark by default)
    (function(){
      const saved = localStorage.getItem('theme');
      const isDark = saved ? saved==='dark' : true;
      if (isDark) document.documentElement.classList.add('dark');
    })();
  </script>

  <div class="max-w-7xl mx-auto p-6">
    <!-- Header -->
    <header class="sticky top-4 z-10 mb-8">
      <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl px-5 py-4 shadow-2xl flex flex-col md:flex-row md:items-center md:justify-between">
        <div class="flex items-center gap-3">
          <div class="w-11 h-11 rounded-2xl bg-gradient-to-tr from-emerald-400 via-teal-400 to-sky-400 text-black grid place-items-center font-extrabold shadow-xl">iB</div>
          <div>
            <h1 class="text-2xl font-extrabold tracking-tight">iBanking Tuition</h1>
            <p class="text-slate-300/80 text-xs">Tra cứu học phí • Thanh toán an toàn</p>
          </div>
        </div>
        <div class="flex flex-wrap items-center gap-2 mt-4 md:mt-0">
          <span class="text-xs text-slate-300/80">API</span>
          <input id="baseUrl" class="w-64 rounded-xl border border-white/10 bg-white/10 px-3 py-2 text-sm outline-none focus:shadow-glow" placeholder="http://localhost:3000"/>
          <button id="themeToggle" class="rounded-xl border border-white/10 bg-white/10 px-3 py-2 text-sm hover:bg-white/15 transition flex items-center gap-2" title="Chuyển giao diện">
            <i class="ph ph-sun text-amber-300"></i><i class="ph ph-moon text-sky-300"></i>
          </button>
          <button id="loginBtn" class="rounded-xl bg-brand px-3 py-2 text-sm font-semibold text-emerald-950 hover:bg-brand/90 shadow">Đăng nhập</button>
          <button id="logoutBtn" class="hidden rounded-xl bg-rose-500 px-3 py-2 text-sm font-semibold hover:bg-rose-400">Đăng xuất</button>
        </div>
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Lookup Card -->
      <section class="lg:col-span-2 rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl shadow-2xl">
        <div class="p-6 sm:p-8">
          <h2 class="text-xl font-bold flex items-center gap-2"><i class="ph ph-graduation-cap"></i> Tra cứu học phí theo MSSV</h2>
          <p class="mt-1 text-sm text-slate-300/80">Nhập MSSV để xem thông tin và hóa đơn gần nhất. Nếu server yêu cầu xác thực, hệ thống sẽ bật pop‑up đăng nhập.</p>

          <div class="mt-6 flex flex-col sm:flex-row gap-4">
            <div class="relative flex-1">
              <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-300/70"></i>
              <input id="mssv" class="w-full pl-9 rounded-xl border border-white/10 bg-slate-900/60 px-4 py-3 outline-none focus:shadow-glow" placeholder="Ví dụ: TDTU0001"/>
            </div>
            <div class="flex gap-3">
              <button id="lookup" class="rounded-xl bg-gradient-to-r from-brand to-emerald-400 px-5 py-3 font-semibold text-emerald-950 shadow-lg hover:scale-[.98] active:scale-95 transition"><i class="ph ph-binoculars"></i> Tra cứu</button>
              <button id="demo" class="rounded-xl border border-white/10 bg-white/10 px-5 py-3 font-semibold hover:bg-white/15 transition"><i class="ph ph-flask"></i> Demo</button>
            </div>
          </div>

          <div id="lookupErr" class="min-h-[1.25rem] mt-3 text-sm text-rose-400"></div>

          <!-- Skeleton shimmer -->
          <div id="skeleton" class="hidden mt-6 space-y-3">
            <div class="h-8 w-56 rounded bg-white/10 shimmer"></div>
            <div class="h-12 rounded bg-white/10 shimmer"></div>
            <div class="h-12 rounded bg-white/10 shimmer"></div>
            <div class="h-12 rounded bg-white/10 shimmer"></div>
          </div>

          <div id="result" class="mt-6"></div>
        </div>
      </section>

      <!-- Quick Actions -->
      <aside class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl shadow-2xl">
        <div class="p-6">
          <h2 class="text-lg font-semibold flex items-center gap-2"><i class="ph ph-flash"></i> Hành động nhanh</h2>
          <div class="mt-4 space-y-3">
            <button class="action w-full flex items-center gap-2 rounded-xl border border-white/10 bg-white/10 px-4 py-3 font-semibold hover:bg-white/15 transition" data-action="prepare"><i class="ph ph-credit-card"></i> Chuẩn bị thanh toán</button>
            <button class="action w-full flex items-center gap-2 rounded-xl border border-white/10 bg-white/10 px-4 py-3 font-semibold hover:bg-white/15 transition" data-action="confirm"><i class="ph ph-shield-check"></i> Xác nhận OTP</button>
            <button class="action w-full flex items-center gap-2 rounded-xl border border-white/10 bg-white/10 px-4 py-3 font-semibold hover:bg-white/15 transition" data-action="history"><i class="ph ph-clock-counter-clockwise"></i> Lịch sử giao dịch</button>
          </div>
          <p class="mt-4 text-sm text-slate-300/80">Các chức năng này cần đăng nhập. Khi bấm, hệ thống sẽ bật pop‑up đăng nhập nếu bạn chưa đăng nhập.</p>
        </div>
      </aside>
    </div>
  </div>

  <!-- Backdrop & Modals -->
  <div id="modalBackDrop" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-50"></div>

  <!-- Login Modal -->
  <div id="loginModal" class="hidden fixed inset-0 z-50 grid place-items-center p-4">
    <div class="w-full max-w-md rounded-2xl border border-white/10 bg-slate-900/80 backdrop-blur-xl p-6 shadow-2xl pop">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Đăng nhập</h3>
        <button class="close rounded-lg border border-white/10 bg-white/10 px-2 py-1 hover:bg-white/15" data-close>✕</button>
      </div>
      <label class="text-sm text-slate-300">Tên đăng nhập</label>
      <input id="lgUser" class="mt-1 w-full rounded-xl border border-white/10 bg-slate-900/60 px-3 py-2 outline-none focus:shadow-glow" placeholder="sv01" />
      <label class="mt-3 text-sm text-slate-300">Mật khẩu</label>
      <input id="lgPass" type="password" class="mt-1 w-full rounded-xl border border-white/10 bg-slate-900/60 px-3 py-2 outline-none focus:shadow-glow" placeholder="123456"/>
      <div id="lgErr" class="min-h-[1.25rem] mt-2 text-sm text-rose-400"></div>
      <div class="flex justify-end gap-3 mt-4">
        <button id="fillDemo" class="rounded-xl border border-white/10 bg-white/10 px-4 py-2 hover:bg-white/15">Dùng thử</button>
        <button id="doLogin" class="rounded-xl bg-brand px-4 py-2 font-semibold text-emerald-950 hover:bg-brand/90">Đăng nhập</button>
      </div>
    </div>
  </div>

  <!-- Prepare Payment Modal -->
  <div id="payModal" class="hidden fixed inset-0 z-50 grid place-items-center p-4">
    <div class="w-full max-w-md rounded-2xl border border-white/10 bg-slate-900/80 backdrop-blur-xl p-6 shadow-2xl pop">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Chuẩn bị thanh toán</h3>
        <button class="close rounded-lg border border-white/10 bg-white/10 px-2 py-1 hover:bg-white/15" data-close>✕</button>
      </div>
      <label class="text-sm text-slate-300">MSSV</label>
      <input id="payMssv" class="mt-1 w-full rounded-xl border border-white/10 bg-slate-900/60 px-3 py-2 outline-none focus:shadow-glow" placeholder="TDTU0001"/>
      <label class="mt-3 text-sm text-slate-300">Số tiền</label>
      <input id="payAmount" type="number" min="1000" step="1000" class="mt-1 w-full rounded-xl border border-white/10 bg-slate-900/60 px-3 py-2 outline-none focus:shadow-glow" placeholder="1000000"/>
      <p class="mt-2 text-sm text-slate-300/80">Sau khi gửi, hệ thống sẽ gửi mã OTP về email tài khoản của bạn.</p>
      <div id="payErr" class="min-h-[1.25rem] mt-1 text-sm text-rose-400"></div>
      <div class="flex justify-end mt-4">
        <button id="doPrepare" class="rounded-xl bg-brand px-4 py-2 font-semibold text-emerald-950 hover:bg-brand/90">Gửi OTP</button>
      </div>
    </div>
  </div>

  <!-- OTP Confirm Modal -->
  <div id="otpModal" class="hidden fixed inset-0 z-50 grid place-items-center p-4">
    <div class="w-full max-w-md rounded-2xl border border-white/10 bg-slate-900/80 backdrop-blur-xl p-6 shadow-2xl pop">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Xác nhận OTP</h3>
        <button class="close rounded-lg border border-white/10 bg-white/10 px-2 py-1 hover:bg-white/15" data-close>✕</button>
      </div>
      <p id="otpHint" class="text-sm text-slate-300/80">Nhập mã OTP (6 chữ số) vừa được gửi email.</p>
      <label class="mt-3 text-sm text-slate-300">Mã OTP</label>
      <input id="otpCode" inputmode="numeric" pattern="\d{6}" maxlength="6" class="mt-1 w-full rounded-xl border border-white/10 bg-slate-900/60 px-3 py-2 outline-none focus:shadow-glow" placeholder="123456"/>
      <div id="otpErr" class="min-h-[1.25rem] mt-1 text-sm text-rose-400"></div>
      <div class="flex justify-end mt-4">
        <button id="doConfirm" class="rounded-xl bg-brand px-4 py-2 font-semibold text-emerald-950 hover:bg-brand/90">Xác nhận</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 hidden max-w-sm rounded-xl border border-white/10 bg-slate-900/90 backdrop-blur px-4 py-3 text-slate-100 shadow-xl"></div>

  <script>
    // ===== Helpers =====
    const $ = (sel, el=document)=> el.querySelector(sel);
    const apiInput = $('#baseUrl');
    const loginBtn = $('#loginBtn');
    const logoutBtn = $('#logoutBtn');
    const tokenKey = 'token';
    const userKey = 'user';
    const DEFAULT_API = 'http://localhost:3000';

    // Theme toggle
    document.getElementById('themeToggle').addEventListener('click', ()=>{
      const on = document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', on ? 'dark' : 'light');
    });

    // Backdrop + modal helpers
    const backdrop = $('#modalBackDrop');
    function showBackdrop(){ backdrop.classList.remove('hidden'); backdrop.classList.add('flex'); }
    function hideBackdrop(){ backdrop.classList.add('hidden'); backdrop.classList.remove('flex'); }
    function openModal(sel){ showBackdrop(); const m=$(sel); m.classList.remove('hidden'); }
    function closeAll(){ hideBackdrop(); document.querySelectorAll('#loginModal,#payModal,#otpModal').forEach(m=>m.classList.add('hidden')); }
    document.querySelectorAll('[data-close]').forEach(x=> x.addEventListener('click', closeAll));
    backdrop.addEventListener('click', closeAll);

    // API base
    apiInput.value = localStorage.getItem('apiBase') || DEFAULT_API;
    apiInput.addEventListener('change', ()=> localStorage.setItem('apiBase', api()));
    function api(){ return (apiInput.value || DEFAULT_API).replace(/\$/,''); }

    // Auth helpers
    function token(){ return localStorage.getItem(tokenKey) || '' }
    function setAuth(t, u){ localStorage.setItem(tokenKey, t); localStorage.setItem(userKey, JSON.stringify(u)); renderAuth(); }
    function clearAuth(){ localStorage.removeItem(tokenKey); localStorage.removeItem(userKey); renderAuth(); }
    function renderAuth(){ const isLogged=!!token(); loginBtn.classList.toggle('hidden', isLogged); logoutBtn.classList.toggle('hidden', !isLogged); }
    renderAuth();

    function authFetch(path, opts={}){ const headers=Object.assign({'Content-Type':'application/json'}, opts.headers||{}); if(token()) headers.Authorization='Bearer '+token(); return fetch(api()+path, Object.assign({},opts,{headers})); }

    // Toast
    function showToast(text){ const t=$('#toast'); t.textContent=text; t.classList.remove('hidden'); t.classList.add('pop'); setTimeout(()=>t.classList.add('hidden'), 2400); }

    // ===== Lookup flow =====
    $('#demo').addEventListener('click', ()=> $('#mssv').value = 'TDTU0001');
    $('#lookup').addEventListener('click', async ()=>{
      const mssv=$('#mssv').value.trim(); const err=$('#lookupErr'); err.textContent=''; $('#result').innerHTML=''; if(!mssv){ err.textContent='Vui lòng nhập MSSV.'; return; }
      try{ $('#skeleton').classList.remove('hidden'); const res=await authFetch('/api/students?'+new URLSearchParams({mssv}), {method:'GET'}); if(res.status===401){ openLogin(()=> $('#lookup').click()); return; }
        const data=await res.json(); if(!res.ok) throw new Error(data?.message||'Tra cứu thất bại'); renderResult(data); }
      catch(e){ err.textContent=e.message||'Lỗi không xác định'; }
      finally{ $('#skeleton').classList.add('hidden'); }
    });

    function renderResult({ student, invoice }){
      // status color
      const status=(invoice?.status||'-').toLowerCase();
      const color = status.includes('paid')||status.includes('đã')? 'bg-emerald-500/15 text-emerald-300 border-emerald-500/30'
                  : status.includes('pending')||status.includes('chờ')? 'bg-amber-500/15 text-amber-300 border-amber-500/30'
                  : status.includes('overdue')||status.includes('quá hạn')? 'bg-rose-500/15 text-rose-300 border-rose-500/30'
                  : 'bg-slate-500/15 text-slate-300 border-slate-500/30';

      const html = `
        <div class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur p-4 pop">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-semibold">Kết quả</h3>
            <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs border ${color}"><i class="ph ph-info"></i>${invoice?.status||'-'}</span>
          </div>
          <div class="overflow-hidden rounded-xl border border-white/10">
            <table class="w-full text-sm">
              <tbody class="divide-y divide-white/10">
                <tr class="odd:bg-white/5">
                  <th class="text-left p-3 w-40 text-slate-300">MSSV</th>
                  <td class="p-3">${student.mssv}</td>
                </tr>
                <tr class="odd:bg-white/5">
                  <th class="text-left p-3 text-slate-300">Họ tên</th>
                  <td class="p-3">${student.full_name}</td>
                </tr>
                <tr class="odd:bg-white/5">
                  <th class="text-left p-3 text-slate-300">Tổng phải nộp</th>
                  <td class="p-3">${fmt(invoice?.amount_due)}</td>
                </tr>
                <tr class="odd:bg-white/5">
                  <th class="text-left p-3 text-slate-300">Đã nộp</th>
                  <td class="p-3">${fmt(invoice?.amount_paid)}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="mt-3">
            <button class="rounded-xl bg-gradient-to-r from-brand to-emerald-400 px-4 py-2.5 font-semibold text-emerald-950 hover:scale-[.98] active:scale-95 transition" id="goPay"><i class="ph ph-credit-card"></i> Chuẩn bị thanh toán</button>
          </div>
        </div>`;
      $('#result').innerHTML = html;
      $('#goPay').addEventListener('click', ()=> ensureLoginThen(()=>{ $('#payMssv').value = student.mssv; openModal('#payModal'); }));
    }

    function fmt(v){ return (v==null)?'-':Number(v).toLocaleString('vi-VN',{style:'currency',currency:'VND'}); }

    // ===== Actions need login =====
    document.querySelectorAll('.action').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const action = btn.getAttribute('data-action');
        if (action==='prepare') ensureLoginThen(()=> openModal('#payModal'));
        else if (action==='confirm') ensureLoginThen(()=> openModal('#otpModal'));
        else ensureLoginThen(()=> showToast('Lịch sử giao dịch: bạn có thể thêm sau.'));
      });
    });

    // ===== Login flow =====
    loginBtn.addEventListener('click', ()=> openModal('#loginModal'));
    logoutBtn.addEventListener('click', clearAuth);

    $('#fillDemo').addEventListener('click', ()=>{ $('#lgUser').value='sv01'; $('#lgPass').value='123456'; });
    $('#doLogin').addEventListener('click', doLogin);

    async function doLogin(){
      $('#lgErr').textContent='';
      try{
        const payload = { username: $('#lgUser').value.trim(), password: $('#lgPass').value };
        const res = await fetch(api()+'/api/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        const data = await res.json();
        if (!res.ok) throw new Error(data?.message || 'Đăng nhập thất bại');
        setAuth(data.token, data.user);
        closeAll();
        if (queued) { const fn = queued; queued = null; fn(); }
        showToast('Đăng nhập thành công');
      }catch(e){ $('#lgErr').textContent = e.message || 'Lỗi không xác định'; }
    }

    // ===== Prepare payment & OTP =====
    let lastPayment = { id: null, otp_id: null };

    $('#doPrepare').addEventListener('click', async ()=>{
      $('#payErr').textContent='';
      try{
        const body = { mssv: $('#payMssv').value.trim(), amount: Number($('#payAmount').value) };
        const res = await authFetch('/api/payments/prepare', { method:'POST', body: JSON.stringify(body) });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.message || 'Gửi OTP thất bại');
        lastPayment = { id: data.payment_id, otp_id: data.otp_id };
        closeAll();
        $('#otpHint').textContent = `Nhập OTP cho giao dịch #${data.payment_id}. otp_id=${data.otp_id}.`;
        openModal('#otpModal');
        showToast('Đã gửi OTP tới email');
      }catch(e){ $('#payErr').textContent = e.message || 'Lỗi không xác định'; }
    });

    $('#doConfirm').addEventListener('click', async ()=>{
      $('#otpErr').textContent='';
      try{
        const code = $('#otpCode').value.trim();
        const res = await authFetch(`/api/payments/${lastPayment.id}/confirm?`+new URLSearchParams({ otp_id: lastPayment.otp_id }), { method:'POST', body: JSON.stringify({ otp: code }) });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.message || 'Xác nhận thất bại');
        closeAll();
        showToast('Thanh toán thành công! Mã GD: '+data.payment_id);
      }catch(e){ $('#otpErr').textContent = e.message || 'Lỗi không xác định'; }
    });

    // ===== Login guard queue =====
    let queued = null; function openLogin(after){ queued = after || null; openModal('#loginModal'); } function ensureLoginThen(fn){ if (token()) fn(); else openLogin(fn); }
  </script>
</body>
</html>
