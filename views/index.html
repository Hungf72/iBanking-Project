<!doctype html>
<html lang="vi" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>iBanking Tuition ‚Äî Thanh to√°n h·ªçc ph√≠</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
          colors: { brand: { DEFAULT:'#22c55e', 600:'#16a34a' }, night:'#0b1220' },
          boxShadow: {
            glow: '0 0 0 4px rgba(34,197,94,.28)',
            soft: '0 10px 30px -10px rgba(0,0,0,.5)',
            neon: '0 8px 24px -6px rgba(34,197,94,.45)'
          }
        }
      }
    }
  </script>

  <!-- Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <link rel="stylesheet" href="style.css">

</head>
<body class="min-h-screen bg-fintech text-slate-100 font-sans antialiased">

  <!-- Header -->
  <header class="sticky top-0 z-30">
    <div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 pt-4">
      <div class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl shadow-soft px-4 py-3 md:px-5 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-2xl bg-gradient-to-tr from-emerald-400 via-teal-400 to-sky-400 text-black grid place-items-center font-extrabold shadow-neon">iB</div>
          <div>
            <div class="text-lg font-extrabold tracking-tight">iBanking Tuition</div>
            <div class="text-[11px] text-slate-300/75">Thanh to√°n h·ªçc ph√≠ an to√†n</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="themeToggle" class="rounded-xl border border-white/10 bg-white/10 px-3 py-2 text-sm hover:bg-white/15 transition" title="ƒê·ªïi giao di·ªán üåô/‚òÄÔ∏è">
            <i class="ph ph-sun text-amber-300"></i>
          </button>
          <span class="hidden sm:block text-[11px] text-slate-300/75">API</span>
          <input id="baseUrl" class="hidden sm:block w-48 rounded-lg border border-white/10 bg-slate-900/70 px-2.5 py-1.5 text-xs outline-none focus:shadow-glow" placeholder="http://localhost:3000">
          <button id="loginBtn" class="px-3 py-2 rounded-xl bg-gradient-to-r from-brand to-emerald-400 font-semibold text-emerald-950 hover:scale-[.98] active:scale-95 transition shadow-neon text-sm">ƒêƒÉng nh·∫≠p</button>
          <button id="logoutBtn" class="hidden px-3 py-2 rounded-xl bg-rose-500/90 font-semibold text-white hover:bg-rose-500/80 text-sm">ƒêƒÉng xu·∫•t</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Hero / Search -->
  <section class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 mt-6">
    <div class="rounded-3xl border border-white/10 bg-white/10 backdrop-blur-xl shadow-soft pop">
      <div class="px-6 py-6 sm:px-8 sm:py-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-5">
          <div>
            <h1 class="text-3xl font-extrabold tracking-tight">Tra c·ª©u & thanh to√°n h·ªçc ph√≠</h1>
            <p class="text-slate-300/80 text-sm mt-1">Nh·∫≠p MSSV ƒë·ªÉ xem s·ªë ti·ªÅn ph·∫£i n·ªôp v√† thanh to√°n tr·ª±c tuy·∫øn qua OTP.</p>
          </div>
          <div class="w-full md:w-[460px]">
            <div class="relative">
              <i class="ph ph-identification-badge absolute left-3 top-1/2 -translate-y-1/2 text-slate-300/70"></i>
              <input id="mssv" class="w-full pl-9 pr-32 py-3 rounded-2xl border border-white/10 bg-slate-900/70 outline-none focus:shadow-glow"
                     placeholder="Nh·∫≠p MSSV, v√≠ d·ª•: TDTU0001">
              <button id="lookupBtn" class="absolute right-1 top-1/2 -translate-y-1/2 px-4 py-2 rounded-xl bg-gradient-to-r from-brand to-emerald-400 font-semibold text-emerald-950 hover:scale-[.98] active:scale-95 transition shadow-neon text-sm">
                <i class="ph ph-magnifying-glass"></i> Tra c·ª©u
              </button>
            </div>
          </div>
        </div>

        <div id="lookupErr" class="text-sm text-rose-400 mt-3 min-h-[1.25rem]"></div>

        <!-- Skeleton -->
        <div id="skeleton" class="hidden mt-5 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div class="h-12 rounded-xl bg-white/10 shimmer"></div>
          <div class="h-12 rounded-xl bg-white/10 shimmer"></div>
          <div class="h-12 rounded-xl bg-white/10 shimmer"></div>
          <div class="h-12 rounded-xl bg-white/10 shimmer"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Result & Quick pay -->
  <main class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Result -->
    <section class="lg:col-span-2 rounded-3xl border border-white/12 bg-white/10 backdrop-blur-xl shadow-soft pop">
      <div class="p-6 sm:p-8">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold flex items-center gap-2"><i class="ph ph-receipt"></i> Th√¥ng tin h·ªçc ph√≠</h2>
        </div>
        <div id="result" class="text-sm text-slate-300">Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng nh·∫≠p MSSV ƒë·ªÉ tra c·ª©u.</div>
      </div>
    </section>

    <!-- Quick pay -->
    <aside class="rounded-3xl border border-white/12 bg-white/10 backdrop-blur-xl shadow-soft pop">
      <div class="p-6 sm:p-8">
        <h3 class="text-lg font-semibold flex items-center gap-2"><i class="ph ph-lightning"></i> Thanh to√°n nhanh</h3>
        <p class="text-slate-300/80 text-sm mt-1">D√πng k·∫øt qu·∫£ tra c·ª©u hi·ªán t·∫°i ƒë·ªÉ th·ª±c hi·ªán thanh to√°n OTP.</p>
        <div class="mt-4">
          <button id="payBtn" class="w-full rounded-2xl bg-gradient-to-r from-brand to-emerald-400 px-5 py-3 font-semibold text-emerald-950 hover:scale-[.98] active:scale-95 transition shadow-neon">
            <i class="ph ph-credit-card"></i> Thanh to√°n ngay
          </button>
          <div id="payErr" class="text-sm text-rose-400 min-h-[1.25rem] mt-2"></div>
        </div>
      </div>
    </aside>
  </main>

  <!-- Recent table -->
  <section class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 mt-6 mb-12">
    <div class="rounded-3xl border border-white/10 bg-white/10 backdrop-blur-xl shadow-soft pop">
      <div class="p-6 sm:p-8">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-semibold flex items-center gap-2"><i class="ph ph-clock-counter-clockwise"></i> Giao d·ªãch g·∫ßn ƒë√¢y</h3>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="text-left text-slate-300/75 border-b border-white/10">
              <tr>
                <th class="py-2">Th·ªùi gian</th>
                <th class="py-2">MSSV</th>
                <th class="py-2">S·ªë ti·ªÅn</th>
                <th class="py-2">Tr·∫°ng th√°i</th>
              </tr>
            </thead>
            <tbody id="recentTbody" class="divide-y divide-white/10"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- Backdrop & Modals -->
  <div id="modalBackDrop" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-50"></div>

  <!-- Login Modal -->
  <div id="loginModal" class="hidden fixed inset-0 z-50 grid place-items-center p-4">
    <div class="w-full max-w-md rounded-2xl border border-white/12 bg-slate-900/85 backdrop-blur-2xl p-6 shadow-soft zoom">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">ƒêƒÉng nh·∫≠p</h3>
        <button class="close px-2 py-1 rounded-lg border border-white/10 bg-white/10 hover:bg-white/15" data-close>‚úï</button>
      </div>
      <label class="text-sm text-slate-300">T√†i kho·∫£n</label>
      <input name="username" id="lgUser" type="text" class="mt-1 w-full rounded-xl border border-white/12 bg-slate-900/70 px-3 py-2 outline-none focus:shadow-glow" placeholder="user01">
      <label class="text-sm text-slate-300 mt-3">M·∫≠t kh·∫©u</label>
      <input name="password" id="lgPass" type="password" class="mt-1 w-full rounded-xl border border-white/12 bg-slate-900/70 px-3 py-2 outline-none focus:shadow-glow" placeholder="123456">
      <div id="lgErr" class="text-sm text-rose-400 mt-2 min-h-[1.25rem]"></div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="fillDemo" class="rounded-xl border border-white/10 bg-white/10 px-4 py-2 hover:bg-white/15">D√πng th·ª≠</button>
        <button type="submit" id="doLogin" class="rounded-xl bg-gradient-to-r from-brand to-emerald-400 px-4 py-2 font-semibold text-emerald-950 hover:scale-[.98] active:scale-95 transition shadow-neon">ƒêƒÉng nh·∫≠p</button>
      </div>
    </div>
  </div>

  <!-- OTP Modal -->
  <div id="otpModal" class="hidden fixed inset-0 z-50 grid place-items-center p-4">
    <div class="w-full max-w-md rounded-2xl border border-white/12 bg-slate-900/85 backdrop-blur-2xl p-6 shadow-soft zoom">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">X√°c nh·∫≠n OTP</h3>
        <button class="close px-2 py-1 rounded-lg border border-white/10 bg-white/10 hover:bg-white/15" data-close>‚úï</button>
      </div>
      <p id="otpHint" class="text-sm text-slate-300/80">Nh·∫≠p m√£ OTP (6 ch·ªØ s·ªë) v·ª´a ƒë∆∞·ª£c g·ª≠i email.</p>
      <label class="mt-3 text-sm text-slate-300">M√£ OTP</label>
      <input id="otpCode" inputmode="numeric" maxlength="6" class="mt-1 w-full rounded-xl border border-white/12 bg-slate-900/70 px-3 py-2 outline-none focus:shadow-glow" placeholder="123456">
      <div id="otpErr" class="text-sm text-rose-400 mt-2 min-h-[1.25rem]"></div>
      <div class="flex justify-end mt-4">
        <button id="doConfirm" class="rounded-xl bg-gradient-to-r from-brand to-emerald-400 px-4 py-2 font-semibold text-emerald-950 hover:scale-[.98] active:scale-95 transition shadow-neon">X√°c nh·∫≠n</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 hidden max-w-sm rounded-xl border border-white/10 bg-slate-900/92 backdrop-blur px-4 py-3 text-slate-100 shadow-soft slide-in"></div>

  <!-- Logic -->
  <script>
    // ===== Theme =====
    (function(){ const saved = localStorage.getItem('theme'); if(saved==='light'){ document.documentElement.classList.remove('dark'); } })();
    document.getElementById('themeToggle').addEventListener('click', ()=>{
      const on = document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', on ? 'dark' : 'light');
    });

    // ===== Globals / State =====
    const $ = (s,el=document)=>el.querySelector(s);
    let queued = null;

    const apiInput = $('#baseUrl');
    const tokenKey='token', userKey='user';
    const DEFAULT_API='http://localhost:8080';

    apiInput.value = localStorage.getItem('apiBase') || DEFAULT_API;
    apiInput.addEventListener('change', ()=> localStorage.setItem('apiBase', api()));
    function api(){ return (apiInput.value || DEFAULT_API).replace(/\/$/, ''); }

    function token(){ return localStorage.getItem(tokenKey) || '' }
    function setAuth(t,u){ localStorage.setItem(tokenKey,t); localStorage.setItem(userKey,JSON.stringify(u)); renderAuth(); }
    function clearAuth(){ localStorage.removeItem(tokenKey); localStorage.removeItem(userKey); renderAuth(); }
    function renderAuth(){ const on=!!token(); $('#loginBtn').classList.toggle('hidden',on); $('#logoutBtn').classList.toggle('hidden',!on); }
    renderAuth();

    function authFetch(path, opts={}){
      const headers = Object.assign({'Content-Type':'application/json'}, opts.headers||{});
      if (token()) headers['Authorization'] = 'Bearer ' + token();
      return fetch(api()+path, Object.assign({}, opts, { headers }));
    }

    // ===== Toast =====
    function toast(text){ const t=$('#toast'); t.textContent=text; t.classList.remove('hidden'); t.classList.add('slide-in'); setTimeout(()=> t.classList.add('hidden'), 2400); }

    // ===== Backdrop & Modal =====
    const backdrop = $('#modalBackDrop');
    function openModal(sel){ backdrop.classList.remove('hidden'); backdrop.classList.add('flex'); $(sel).classList.remove('hidden'); }
    function closeAll(){ backdrop.classList.add('hidden'); ['#loginModal','#otpModal'].forEach(id=>$(id).classList.add('hidden')); }
    document.querySelectorAll('[data-close]').forEach(b=> b.addEventListener('click', closeAll));
    backdrop.addEventListener('click', closeAll);

    // ===== Lookup Tuition =====
    let lastLookup = null;
    $('#lookupBtn').addEventListener('click', async ()=>{
      const mssv = $('#mssv').value.trim();
      $('#lookupErr').textContent=''; $('#result').innerHTML='';
      if(!mssv){ $('#lookupErr').textContent='Vui l√≤ng nh·∫≠p MSSV'; return; }
      $('#skeleton').classList.remove('hidden');

      try{
        const res = await authFetch('/api/students?'+new URLSearchParams({ mssv }), { method:'GET' });
        if(res.status===401){ queued = ()=> $('#lookupBtn').click(); openModal('#loginModal'); return; }
        const data = await res.json();
        if(!res.ok) throw new Error(data?.message || 'Tra c·ª©u th·∫•t b·∫°i');

        lastLookup = data;
        const html = `
          <div class="border border-white/12 rounded-2xl p-4 bg-white/5">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div><span class="text-slate-300/90">MSSV:</span> <b>${data.student.mssv}</b></div>
              <div><span class="text-slate-300/90">H·ªç t√™n:</span> <b>${data.student.full_name}</b></div>
              <div><span class="text-slate-300/90">T·ªïng ph·∫£i n·ªôp:</span> <b>${fmt(data.invoice?.amount_due)}</b></div>
              <div><span class="text-slate-300/90">ƒê√£ n·ªôp:</span> <b>${fmt(data.invoice?.amount_paid)}</b></div>
              <div class="sm:col-span-2">
                <span class="text-slate-300/90">Tr·∫°ng th√°i:</span>
                <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs border ${tagColor(data.invoice?.status)}">
                  ${statusIcon(data.invoice?.status)} ${data.invoice?.status || '-'}
                </span>
              </div>
            </div>
          </div>`;
        $('#result').innerHTML = html;
      }catch(e){
        $('#lookupErr').textContent = e.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh';
        lastLookup = null;
      }finally{
        $('#skeleton').classList.add('hidden');
      }
    });

    function statusIcon(txt=''){
      const t = (txt||'').toLowerCase();
      if(t.includes('ƒë√£')||t.includes('paid')) return '<i class="ph ph-check-circle"></i>';
      if(t.includes('ch·ªù')||t.includes('pending')) return '<i class="ph ph-hourglass"></i>';
      if(t.includes('qu√°')||t.includes('overdue')) return '<i class="ph ph-x-circle"></i>';
      return '<i class="ph ph-info"></i>';
    }
    function tagColor(text=''){
      const t=text.toLowerCase();
      if(t.includes('ƒë√£')||t.includes('paid')) return 'bg-emerald-500/15 border-emerald-500/30 text-emerald-300';
      if(t.includes('ch·ªù')||t.includes('pending')) return 'bg-amber-500/15 border-amber-500/30 text-amber-300';
      if(t.includes('qu√°')||t.includes('overdue')) return 'bg-rose-500/15 border-rose-500/30 text-rose-300';
      return 'bg-slate-500/15 border-slate-500/30 text-slate-300';
    }
    function fmt(v){ return (v==null)?'-':Number(v).toLocaleString('vi-VN',{style:'currency',currency:'VND'}); }

    // ===== Pay (prepare + OTP) =====
    let lastPayment = null;
    $('#payBtn').addEventListener('click', ()=> ensureLoginThen(doPrepare));

    async function doPrepare(){
      $('#payErr').textContent='';
      try{
        const mssv = $('#mssv').value.trim();
        if(!mssv || !lastLookup){ $('#payErr').textContent='Vui l√≤ng tra c·ª©u MSSV tr∆∞·ªõc'; return; }
        const res = await authFetch('/api/payments/prepare', { method:'POST', body: JSON.stringify({ mssv }) });
        const data = await res.json();
        if(!res.ok) throw new Error(data?.message || 'G·ª≠i OTP th·∫•t b·∫°i');

        lastPayment = { id: data.payment_id, otp_id: data.otp_id };
        $('#otpHint').textContent = `Nh·∫≠p OTP cho giao d·ªãch #${data.payment_id}. otp_id=${data.otp_id}.`;
        openModal('#otpModal');
        toast('ƒê√£ g·ª≠i OTP t·ªõi email');
      }catch(e){ $('#payErr').textContent = e.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'; }
    }

    $('#doConfirm').addEventListener('click', async ()=>{
      $('#otpErr').textContent='';
      try{
        const code = $('#otpCode').value.trim();
        if(!lastPayment){ $('#otpErr').textContent='Kh√¥ng t√¨m th·∫•y giao d·ªãch'; return; }
        const res = await authFetch(`/api/payments/${lastPayment.id}/confirm?`+new URLSearchParams({ otp_id: lastPayment.otp_id }), {
          method:'POST', body: JSON.stringify({ otp: code })
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data?.message || 'X√°c nh·∫≠n th·∫•t b·∫°i');
        closeAll();
        toast('Thanh to√°n th√†nh c√¥ng!');
        addRecent($('#mssv').value, fmt(data.amount || lastLookup?.invoice?.amount_due || 0), 'ƒê√£ thanh to√°n');
      }catch(e){ $('#otpErr').textContent = e.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'; }
    });

    function addRecent(mssv, amount, status){
      const tr=document.createElement('tr'); const now=new Date();
      tr.innerHTML = `
        <td class="py-2">${now.toLocaleString('vi-VN')}</td>
        <td class="py-2">${mssv}</td>
        <td class="py-2">${amount}</td>
        <td class="py-2"><span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs border ${tagColor(status)}">
          ${statusIcon(status)} ${status}
        </span></td>`;
      $('#recentTbody').prepend(tr);
    }

    // ===== Login =====
    $('#loginBtn').addEventListener('click', ()=> openModal('#loginModal'));
    $('#logoutBtn').addEventListener('click', clearAuth);
    $('#fillDemo').addEventListener('click', ()=>{ $('#lgUser').value='user01'; $('#lgPass').value='123456'; });

    $('#doLogin').addEventListener('click', async ()=>{
      $('#lgErr').textContent='';
      try{
        const payload={ username: $('#lgUser').value.trim(), password: $('#lgPass').value };
        const res = await fetch(api()+'/api/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const data = await res.json();
        if(!res.ok) throw new Error(data?.message || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i');
        setAuth(data.token, data.user);
        closeAll(); toast('ƒêƒÉng nh·∫≠p th√†nh c√¥ng');
        if(queued){ const fn=queued; queued=null; fn(); }
      }catch(e){ $('#lgErr').textContent = e.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'; }
    });

    // ===== Login guard =====
    function ensureLoginThen(fn){ if(token()) fn(); else { queued=fn; openModal('#loginModal'); } }
  </script>
</body>
</html>
